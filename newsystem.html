<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
  <meta content="text/html; charset=ISO-8859-1" http-equiv="content-type">
  <title>Configuring a new COE RHEL/CentOS 6 linux system</title>
  <style type="text/css">
     body,td { font-family: arial;  font-size: 80%; }
     tt,pre { font-size: 120%; }
     
     LI { margin-top: .4em; }
  </style>
</head>
<body>

<h2>Configuring a new COE RHEL/CentOS 6 linux system</h2>
Charles Roth<br/>
Last update: 2014-12-12

<p/><b>I. Introduction</b><br>
This document 
describes specific steps taken to set up a new RHEL (Red Hat Enterprise Linux, 
or CentOS) version 6 server(s) from ServerBeach.&nbsp;
Basically, this is just a record of what we do to change the base 
configuration of the server as provided by ServerBeach.

<p/>
This is a work-in-progress; check the "last update" data at the top for new versions.

<p/>
<b>II. Basic Server Configuration</b><br/>
<ol>
  <li><b>Domain name</b>
  <ol type="a">
     <li>Add domain name for new server to our existing DNS records.
      <p/>
      Currently, these are maintained by Charles, and are spread
       across 3 different DNS servers around the country.&nbsp;
      (ns1.screenporch.com, ns2.screenporch.com, ns3.screenporch.com.)&nbsp;
      The advantage with this approach is that we can change DNS
      resolution for a server very quickly if we need to migrate to a failover server.&nbsp;
      (Commercial DNS services tend to not be able to react as quickly.)

      <p/>
      The disadvantage is, Charles is an individual, with no other
      support behind him.

      <p/>
      Another option would be to provide Scott(?) with direct access
      to the master DNS server, and appropriate training, if needed.
     </li>

     <li>Use the ServerBeach control panel to register the reverse-DNS
       lookup of the new server's IP address, to our domain name.
   </ol>


<p/>
   
  <li><b>Root login</b>.&nbsp;
   <ol type="a">
   <li>Edit /etc/ssh/sshd_config, make sure it is using "Protocol 2", and 
      "PermitRootLogin yes".&nbsp; Restart sshd with:
      <ul>
      <table>
      <tr><td><tt>ps -ef | grep "/usr/sbin/sshd"&nbsp;&nbsp;&nbsp;</tt></td>   <td>(to find the process id <i>nnnnn</i> of sshd)</td>
      <tr><td><tt>kill -1 <i>nnnnn</i></td>   <td>(to restart sshd)</td>
      </table>
      </ul>

    <p/>
    <li>Change the root password.

    <p/>
    <li>Edit /root/.bash_profile, add this line to the bottom:
<pre>
   export PS1='p7:$PWD # '
</pre>
   where p7 is the short name of the new box.&nbsp;
   Logout and log back in.

<p/>
   <li>Create /root/.forward, and make it contain the addresses
   that 'root' email should go to, e.g.
<pre>
   croth@thedance.net,scott.tudd@gmail.com
</pre>

<p/>
<li>Create ssh key:
<pre>
   mkdir .ssh
   chmod 700 .ssh
   ssh-keygen -b 1024 -t rsa
</ol>
(press Enter at all the prompts)

<p/>
<li><b>Install git</b>.&nbsp; As root,
<pre>
   yum install git
</pre>

<p/>
<li><b>Set up Iptables firewall</b>.&nbsp;
<ol type="a">
<li>As root, check out the COE scripts repository, 
and copy the firewall scripts to /usr/local/bin:
<pre>
   git clone git@github.com:wcroth55/coe.git COE
   cp COE/firewall          /usr/local/bin
   cp COE/firewallRules.txt /usr/local/bin
   chmod 700                /usr/local/bin/firewall*
</pre>
(If the checkout does not work, ask Charles to add the contents  of .ssh/id_rsa.pub to
the list of ssh keys for the COE project.&nbsp;
Or just check out the project to your laptop, and copy the firewall files over
manually.)

<li>Edit /usr/local/bin/firewallRules.txt to
assign roles and IP addresses as appropriate.&nbsp;
See the comments at the top of the file for details.&nbsp;
<p/>
Make sure to include port 22 access to ServerBeach 
staff, seems like we always have to ask them which
IP address ranges to include.

<p/>
<li>Edit /etc/rc.d/rc.local, and add the following line to the bottom:
<pre>
   /usr/local/bin/firewall
</pre>

This will ensure the firewall gets turned on when the server reboots.

<p/>
<b>Note:</b> make sure to do:
<pre>
   chmod 755 /etc/rc.d/rc/local
</pre>

<p/>
<li>
<b>Important: turn on the firewall now!</b>&nbsp;
As root, just type:
<pre>
   firewall
</pre>
</ol>

<p/>
<li><b>Update all installed software</b>.&nbsp;
As root, do:
<pre>
   yum update
</pre>
and answer "yes" or the equivalent to all questions.


<p/>
<li><b>Time</b>
<ol type="a">
<li>Set time zone to Eastern US:
<pre>
   rm -f /etc/localtime
   ln -s /usr/share/zoneinfo/America/New_York /etc/localtime
</pre>

<p/>
<li>Enable ntpd time correction:
<pre>
   service ntpd start
</pre>

Edit /etc/rc.d/rc.local, and add the line:
<pre>
   /sbin/service ntpd start
</pre>

</ol>

<p/>
<li><b>Web server</b>
  <ol type="a">
  <li>Install:
<pre>
   yum install httpd.x86_64
</pre>

  <p/>
  <li>Make configuration changes.
   <ol type="i">
   <li>Copy local.conf from the git COE checkout, to /etc/httpd/conf.
   <li>Edit local.conf to put in correct ServerAdmin, ServerName, NameVirtualHost IP address.
   <li>Edit /etc/httpd/conf/httpd.conf:<br/>
      Comment out "AddDefaultCharset UTF-8"<br/>
      Add "Include conf/local.conf" (to the very end)<br/>
      Comment out "UserDir disabled"<br/>
   </ol>

   <li><tt>mkdir /etc/httpd/conf/vhosts</tt>
 
   <li>Edit /etc/rc.d/rc.local, add
<pre>
   /sbin/service httpd start
</pre>

   <li>Start web server:
<pre>
   service httpd start
</pre>

  </ol>

  <p/>
  <li>Add additional disk(s)</b>, if relevant.&nbsp;
      Example shown for adding a second disk.
<pre>
   fdisk /dev/sdb
   n
   p
   1
         <i>(press Enter to accept default)</i>
         <i>(press Enter to accept default)</i>
   w

   mkfs -t ext3 /dev/sdb1
   mkdir /disk2
   mount -t ext3 /dev/sdb1 /disk2
   df -k
</pre>
(The last line should show both disks, sda1 and sdb1, as mounted and available.)

<p/>
And (of course), add the mount command to /etc/rc.d/rc.local:
<pre>
   /bin/mount -t ext3 /dev/sdb1 /disk2
</pre>

   

</ol>

<p/>
<b>III. Install software needed to build and run Caucus</b>.

<ol>
<li><b>MySQL</b>.&nbsp;

<pre>
   yum install mysql
   yum install mysql-server.x86_64
   yum install mysql-devel.x86_64
</pre>

Edit /etc/my.cnf, and (before the [mysqld_safe] section),
add these lines to make MySQL use a larger share of RAM:
<pre>
   #---Optimization changes
   innodb_log_file_size = 100M
   innodb_buffer_pool_size = 4000M
   innodb_flush_method = O_DIRECT
   innodb_flush_log_at_trx_commit = 2
   table_cache = 8192
   open_files_limit = 8192
   innodb_support_xa = off
   max_connections=500
</pre>

Then continue with starting and initializing MySQL:

<pre>
   service mysqld start
   mysql_secure_installation
</pre>
and answer Y to all of the questions.
<p/>
Verify that you can use MySQL:
<pre>
   mysql -u root -p
   show databases;
   quit;
</pre>

Start MySQL at boot: edit /etc/rc.d/rc.local, and add
<pre>
   /sbin/service mysqld start
</pre>

<p/>
<li><b>C development tools</b>
<pre>
   yum install subversion.x86_64
   yum install gcc.x86_64
</pre>

<p/>
<li><b>Java</b>
<pre>
   yum install java-1.7.0-openjdk.x86_64
</pre>

<p/>
<li><b>ImageMagick</b>
<pre>
   yum install ImageMagick.x86_64
</pre>

</ol>

<b>IV. Build and Test Caucus</b>
<ol>
<li>Make a userid to test in, e.g.
<pre>
   useradd -u 1000 -d /home/croth croth
   passwd croth
</pre>

<li>Export Caucus source.&nbsp;
Logged in as a normal (non-root) user, do:
<pre>
   svn export svn://caucus.com/caucus/trunk C5
</pre>

<li>Build.&nbsp; For a CentOS 6.6 64-bit system, use:
<pre>
   cd C5
   export CPPFLAGS="-D_GNU_SOURCE"
   ./configure --mysqllib=/usr/lib64/mysql/libmysqlclient.so --nosasl2
   make
   mv caucus5.tar ~
   cd
   chmod 711 .
</pre>

<li>As root, create a test userid, e.g.
<pre>
   useradd -u 1001 -d /home/p7test p7test
   passwd p7test
</pre>

<li>Login to the test userid, and install Caucus, e.g.:
<pre>
   su - p7test
   tar xvf /home/croth/caucus5.tar
   ./install
</pre>

Suggested hostname: p7test.coexploration.org<br/>
Suggested email participation id: p7test (but just give junk when asked for its password,
not testing that just yet)

<pre>
   cd SWEB
   ./swebd ./swebd.conf
</pre>

<p/>
<li>Configure test id for http.
<ol type="a">
<li>Add p7test.coexploration.org to DNS resolution, to point at p7.coexploration.org.
<li>As root, create /etc/httpd/conf/vhosts/p7test.coexploration.org, containing:
<pre>
&lt;VirtualHost 66.135.33.165&gt;
   ServerName p7test.coexploration.org
   DocumentRoot /home/p7test/public_html

   &lt;Directory /home/p7test/SWEB&gt;
      Options All
      AllowOverride All
      allow from all
   &lt;/Directory&gt;
   
   &lt;Directory /home/p7test/REG&gt;
      Options All
      AllowOverride All
      allow from all
   &lt;/Directory&gt;
   
   &lt;Directory /home/p7test/public_html&gt;
      Options -Indexes
   &lt;/Directory&gt;
   
   ScriptAlias  /sweb/   /home/p7test/SWEB/
   ScriptAlias  /reg/    /home/p7test/REG/
   
&lt;/VirtualHost&gt;
</pre>

<li>As root, restart http:
<pre>
   service httpd restart
</pre>

</ol>
<li>Point a browser at http://p7test.coexploration.org.&nbsp;<br/>
Create the manager user (specified in the install dialog),
login, create a conference, and create an item.

<p/>
<li>Additional configuration.&nbsp; Edit the Caucus configuration
file (e.g. /home/p7test/SWEB/swebd.conf) and change values
needed for your specific site.&nbsp;
For example:
<pre>
   Config convertDir /usr/bin

   Config url  /usr/bin/curl
</pre>

</ol>

</ol>

<p/>
<b>V. Antivirus</b>
The primary purpose of the antivirus software is to detect
virus-laden software that is uploaded by users <b>into</b>
Caucus.

<ol>
<li>Prepare clamav user and group.
<pre>
   groupadd clamav
   useradd -g clamav -s /bin/false -c "Clam AntiVirus" clamav
</pre>

<li>Download source for the free ClamAV from 
http://www.clamav.net/download.html#sourcecode

<li>Build.&nbsp;
As root, do:
<pre>
   tar xvf clamav-0.98.5.tar.gz
   cd clamav-0.98.5
   ./configure
   make
   make install

   mkdir -p /usr/local/share/clamav
   chown clamav:clamav /usr/local/share/clamav

   touch /var/log/clamd.log
   chown clamav /var/log/clamd.log

   touch /var/log/freshclam.log
   chown clamav /var/log/freshclam.log
</pre>

<li>Configure:
<ol type="a">
<li>Copy /usr/local/etc/clamd.conf.sample to /usr/local/etc/clamd.conf.&nbsp;
Edit the latter file.<br/>
Uncomment the "TCPSocket" line.</br>
Comment out "Example".<br/>
Change the commented-out LogFile line to:
<pre>
   LogFile /var/log/clamd.log
</pre>

<p/>
<li>Copy /usr/local/etc/freshclam.conf to /usr/local/etc/freshclam.conf.<br/>
Comment out the "Example" line.<br/>
Uncomment the UpdateLogFile line.<br/>
Change the DatabaseMirror line to (uncommented):
<pre>
   DatabaseMirror db.us.clamav.net
</pre>

<p/>
<li>Run 'freshclam' virus signature update tool:
<pre/>
   freshclam
</pre>

<p/>
<li>Run 'freshclam' once a day.&nbsp; Add (something like) the following
to your crontab:
<pre>
   10 3 * * * /usr/local/bin/freshclam --quiet
</pre>

<p/>
<li>Start the 'clamd' daemon:
<pre>
   clamd
</pre>

<p/>
<li>Run 'clamd' at boot time.&nbsp;
Edit /etc/rc.d/rc.local and add:
<pre>
   /usr/local/sbin/clamd
</pre>

<p/>
<li>Connect to Caucus.<br/>
Copy the 'viruschecker' file from the COE git repository, to /usr/local/bin.
<pre>
   chmod 755 /usr/local/bin/viruschecker
</pre>

</ol>

<p/>
<b>VI. Configure Email</b>
<ol>
<li>Create a new userid 'mailhandler', e.g. something like:
<pre>
   adduser -u 1003 -d /home/mailhandler mailhandler
</pre>

<li>Set it to throw away email it receives.&nbsp;
(Later we'll reconfigure it to handle incoming
email-to-a-Caucus-item.)
<pre>
   su - mailhandler
   echo "/dev/null" >.forward
   chmod 755 .forward
</pre>

<p/>
<li>Configure postfix email.&nbsp;
Add the text below to the end of /etc/postfix/main.cf,
substituting in the appropriate values for the underlined text:

<pre>
   inet_interfaces = all
   myhostname=<u>p7.coexploration.org</u>
   mydestination = $myhostname, localhost.$mydomain, localhost
   mynetworks = <u>66.135.33.165</u>, 127.0.0.1
   myorigin = $myhostname
   #alias_maps = hash:/etc/postfix/aliases
   #alias_database = hash:/etc/postfix/aliases
   smtpd_sasl_auth_enable = yes
   broken_sasl_auth_clients = yes
   smtpd_recipient_restrictions = permit_mynetworks, permit_sasl_authenticated, reject_unauth_destination
   max_use=10
   local_recipient_maps =
   luser_relay = mailhandler
   #canonical_maps = hash:/etc/postfix/sender_canonical
</pre>

<p/>
Then restart Postfix:
<pre>
   service postfix restart
</pre>

<p/>
<li>Allow incoming email.&nbsp;
Edit /usr/local/bin/firewallRules.txt, and change the ANYONE rule at the bottom
to include port 25, e.g.
<pre>
   ANYONE gets 80 443 25
</pre>
Then restart the firewall.&nbsp; As root, run:
<pre>
   firewall
</pre>


</ol>



<p/>
<b>VII. Next?</b>
<ol>
<li>Docker?
<li>Backups?
<li>MySQL master/slave?
<li>How-To move an existing Caucus site (easy)
<li>...?
</ol>


</body>
</html>
